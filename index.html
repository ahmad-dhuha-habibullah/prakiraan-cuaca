<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info Cuaca Hari Ini</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òÄÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General styles */
        :root {
            --bg-color: #1e1e1e;
            --card-bg-color: rgba(32, 33, 36, 0.9);
            --text-primary: #e0e0e0;
            --text-secondary: #9e9e9e;
            --border-color: #3c4043;
            --active-tab-color: #8ab4f8;
            --active-day-bg: #3c4043;
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-tick-color: #9ca3af;
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --alert-static-bg: rgba(250, 204, 21, 0.15);
            --alert-static-border: #facc15;
        }
        html.light {
            --bg-color: #f1f3f4;
            --card-bg-color: rgba(255, 255, 255, 0.9);
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
            --active-tab-color: #1967d2;
            --active-day-bg: #e8f0fe;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-tick-color: #5f6368;
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --alert-static-bg: #feefc3;
            --alert-static-border: #fbbc04;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        header, footer {
            background-color: var(--card-bg-color);
            border-radius: 1rem;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        main {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.3s;
        }
        .active-tab {
            border-bottom: 2px solid var(--active-tab-color);
            color: var(--active-tab-color);
            font-weight: 500;
        }
        .tab-btn {
             color: var(--text-secondary);
        }
        .active-day {
            background-color: var(--active-day-bg);
            border-radius: 12px;
        }
        .chart-container {
            height: 150px;
        }
        #loader {
            border: 4px solid rgba(128, 128, 128, 0.2);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom dropdown and toggle */
        .custom-select {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .theme-switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #4d4d4d;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #8ab4f8; }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .modal-overlay {
            background-color: var(--modal-overlay-bg);
        }
        .alert-box {
            background-color: var(--alert-static-bg);
            border-left: 4px solid var(--alert-static-border);
            color: var(--text-primary);
        }
        #alert-modal-message ul, #alert-modal-tip ul {
            list-style-position: inside;
            text-align: left;
        }
        #scenery-background {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">
    
    <div id="scenery-background" class="fixed inset-0 z-0"></div>

    <div class="relative z-10 w-full flex flex-col items-center p-2 sm:p-4">
        <!-- App Header -->
        <header class="w-full max-w-4xl mx-auto px-4 sm:px-6 py-3 flex justify-between items-center mb-2">
            <h1 class="text-lg font-bold" style="color: var(--text-primary);">Prakiraan Cuaca</h1>
            <div id="live-datetime" class="text-sm text-right" style="color: var(--text-secondary);"></div>
        </header>

        <!-- First Visit Modal -->
        <div id="first-visit-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
            <div class="p-6 rounded-2xl shadow-xl max-w-sm w-full relative text-center" style="background-color: var(--card-bg-color); color: var(--text-primary);">
                <button id="close-visit-modal-btn" class="absolute top-3 right-3 p-1 rounded-full" style="color: var(--text-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <p class="text-lg font-medium mb-2">Ganti Tema</p>
                <p class="text-sm" style="color: var(--text-secondary);">Anda dapat mengganti tema ke mode terang atau gelap menggunakan tombol di pojok kanan atas.</p>
            </div>
        </div>
        
        <!-- Alert Modal -->
        <div id="alert-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
            <div class="p-6 rounded-2xl shadow-xl max-w-sm w-full relative text-center" style="background-color: var(--card-bg-color); color: var(--text-primary);">
                <button id="close-alert-modal-btn" class="absolute top-3 right-3 p-1 rounded-full" style="color: var(--text-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <div id="alert-modal-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                     <svg id="alert-modal-icon" class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24"></svg>
                </div>
                <h3 id="alert-modal-title" class="text-lg leading-6 font-medium mb-2"></h3>
                <div id="alert-modal-message" class="mt-2 text-sm" style="color: var(--text-secondary);"></div>
                <div class="mt-4 p-3 rounded-lg" style="background-color: rgba(128,128,128,0.1);">
                     <div id="alert-modal-tip" class="text-sm" style="color: var(--text-secondary);"></div>
                </div>
                <div class="mt-5">
                    <button id="share-alert-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium" style="color: var(--text-secondary); background-color: rgba(128,128,128,0.2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        <span>Bagikan Informasi</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Nice Weather Modal -->
        <div id="nice-weather-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
            <div class="p-6 rounded-2xl shadow-xl max-w-sm w-full relative text-center" style="background-color: var(--card-bg-color); color: var(--text-primary);">
                <button id="close-nice-modal-btn" class="absolute top-3 right-3 p-1 rounded-full" style="color: var(--text-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-green-100">
                     <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium mb-2">Cuaca Bagus</h3>
                <div class="mt-2">
                    <p id="nice-modal-message" class="text-sm" style="color: var(--text-secondary);"></p>
                </div>
                <div class="mt-4 p-3 rounded-lg" style="background-color: rgba(128,128,128,0.1);">
                     <p id="nice-modal-tip" class="text-sm text-left" style="color: var(--text-secondary);"></p>
                </div>
                <div class="mt-5">
                    <button id="share-nice-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium" style="color: var(--text-secondary); background-color: rgba(128,128,128,0.2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        <span>Bagikan Informasi</span>
                    </button>
                </div>
            </div>
        </div>


        <div id="loader"></div>

        <main id="weather-content" class="w-full max-w-4xl mx-auto p-4 sm:p-6 rounded-2xl hidden">
            
            <!-- Header -->
            <div class="flex items-center mb-4 gap-2 sm:gap-4">
                <select id="location-select" class="custom-select text-lg font-medium p-2 rounded-lg focus:outline-none shrink-0">
                    <option value="rumah">Kepahiang</option>
                    <option value="kembangan">Kembangan</option>
                </select>
                <div class="flex-grow flex justify-end items-center gap-2 sm:gap-4">
                     <button id="share-btn" class="flex items-center gap-2 p-2 rounded-lg" style="color: var(--text-secondary); background-color: rgba(128,128,128,0.1);" title="Bagikan Cuaca">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        <span class="text-sm font-medium hidden sm:inline">Bagikan Informasi</span>
                    </button>
                    <div class="flex items-center gap-2">
                        <span id="theme-text" class="text-sm" style="color: var(--text-secondary);"></span>
                        <label class="theme-switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Static Alert Notification -->
            <div id="static-alert-container" class="mb-4"></div>

            <!-- Current Weather -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="flex items-center gap-2 sm:gap-4">
                    <div id="current-icon" class="w-16 h-16 sm:w-20 sm:h-20 flex-shrink-0"></div>
                    <div class="flex items-baseline">
                        <span id="main-max-temp" class="text-4xl sm:text-5xl font-bold">--</span>
                        <span id="main-min-temp" class="text-2xl sm:text-3xl" style="color: var(--text-secondary);">/--¬∞</span>
                    </div>
                </div>
                <div class="text-sm flex flex-col justify-center md:text-right" style="color: var(--text-secondary);">
                    <p class="font-medium text-base" id="current-day-time" style="color: var(--text-primary);">--</p>
                    <p id="current-description">--</p>
                    <div id="other-details" class="mt-1">
                        <p>Suhu Sekarang: <span id="current-temp-now" class="font-medium" style="color: var(--text-primary);">--</span></p>
                        <p>Curah Hujan: <span id="current-precip" class="font-medium" style="color: var(--text-primary);">--</span></p>
                        <p>Kelembaban: <span id="current-humidity" class="font-medium" style="color: var(--text-primary);">--</span></p>
                        <p>Angin: <span id="current-wind" class="font-medium" style="color: var(--text-primary);">--</span></p>
                    </div>
                </div>
            </div>

            <!-- Hourly Forecast -->
            <div>
                <div class="flex border-b mb-4" style="border-color: var(--border-color);">
                    <button data-tab="temperature" class="tab-btn px-4 py-2 text-sm active-tab">Suhu</button>
                    <button data-tab="precipitation" class="tab-btn px-4 py-2 text-sm">Curah Hujan</button>
                    <button data-tab="wind" class="tab-btn px-4 py-2 text-sm">Angin</button>
                </div>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <!-- Daily Forecast -->
            <div id="daily-forecast-container" class="grid grid-cols-4 md:grid-cols-8 gap-2 mt-6">
                <!-- Daily forecast items will be injected here -->
            </div>
        </main>
        
        <footer class="w-full max-w-4xl mx-auto py-2 px-4 text-center text-xs mt-2" style="color: var(--text-secondary); background-color: var(--card-bg-color);">
            Dikembangkan oleh ADH
        </footer>
    </div>


    <script>
        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const weatherContent = document.getElementById('weather-content');
        const locationSelect = document.getElementById('location-select');
        const themeToggle = document.getElementById('theme-toggle');
        const themeText = document.getElementById('theme-text');
        const shareBtn = document.getElementById('share-btn');
        const currentIconEl = document.getElementById('current-icon');
        const mainMaxTempEl = document.getElementById('main-max-temp');
        const mainMinTempEl = document.getElementById('main-min-temp');
        const otherDetailsEl = document.getElementById('other-details');
        const currentTempNowEl = document.getElementById('current-temp-now');
        const currentPrecipEl = document.getElementById('current-precip');
        const currentHumidityEl = document.getElementById('current-humidity');
        const currentWindEl = document.getElementById('current-wind');
        const currentDayTimeEl = document.getElementById('current-day-time');
        const currentDescriptionEl = document.getElementById('current-description');
        const hourlyChartCanvas = document.getElementById('hourlyChart');
        const dailyContainer = document.getElementById('daily-forecast-container');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const staticAlertContainer = document.getElementById('static-alert-container');
        const liveDateTimeEl = document.getElementById('live-datetime');
        const sceneryContainer = document.getElementById('scenery-background');
        
        // Modal elements
        const firstVisitModal = document.getElementById('first-visit-modal');
        const closeVisitModalBtn = document.getElementById('close-visit-modal-btn');
        const alertModal = document.getElementById('alert-modal');
        const closeAlertModalBtn = document.getElementById('close-alert-modal-btn');
        const shareAlertBtn = document.getElementById('share-alert-btn');
        const niceWeatherModal = document.getElementById('nice-weather-modal');
        const closeNiceModalBtn = document.getElementById('close-nice-modal-btn');
        const shareNiceBtn = document.getElementById('share-nice-btn');

        // --- State ---
        let weatherData = null;
        let hourlyChart = null;
        let activeTab = 'temperature';
        let selectedDayIndex = 0;

        // --- API & Config ---
        const API_PARAMS = "current=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,wind_direction_10m,is_day&hourly=temperature_2m,relative_humidity_2m,precipitation_probability,weather_code,wind_speed_10m,wind_direction_10m,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max,relative_humidity_2m_max&timezone=Asia%2FBangkok&forecast_days=8";
        const LOCATIONS = {
            "rumah": {
                name: "Kepahiang",
                url: `https://api.open-meteo.com/v1/forecast?latitude=-3.651165&longitude=102.590105&${API_PARAMS}`
            },
            "kembangan": {
                name: "Kembangan",
                url: `https://api.open-meteo.com/v1/forecast?latitude=-6.1852&longitude=106.7265&${API_PARAMS}`
            }
        };
        
        // --- ALERT THRESHOLDS (Customize these values) ---
        const ALERT_THRESHOLDS = {
            RAIN_PROBABILITY: 60, // %
            WIND_SPEED: 25,       // km/h
            HIGH_TEMP: 34         // ¬∞C
        };
        
        const NICE_WEATHER_THRESHOLDS = {
            WEATHER_CODE: 0, // Code for "Cerah"
            RAIN_PROBABILITY: 10, // Max rain probability
            WIND_SPEED: 15 // Max wind speed
        };

        // --- WMO Weather Code Mapping (Bahasa Indonesia) ---
        function getWeatherInfo(code, isDay = 1) {
            const descriptions = {
                0: { desc: "Langit Cerah", icon: isDay ? 'sun' : 'moon' },
                1: { desc: "Cerah Berawan", icon: isDay ? 'sun-cloud' : 'moon-cloud' },
                2: { desc: "Berawan", icon: isDay ? 'sun-cloud' : 'moon-cloud' },
                3: { desc: "Mendung", icon: 'cloud' },
                45: { desc: "Kabut", icon: 'fog' },
                48: { desc: "Kabut Tebal", icon: 'fog' },
                51: { desc: "Gerimis Ringan", icon: 'rain' },
                53: { desc: "Gerimis Sedang", icon: 'rain' },
                55: { desc: "Gerimis Lebat", icon: 'rain' },
                56: { desc: "Gerimis Beku Ringan", icon: 'rain' },
                57: { desc: "Gerimis Beku Lebat", icon: 'rain' },
                61: { desc: "Hujan Ringan", icon: 'rain' },
                63: { desc: "Hujan Sedang", icon: 'rain' },
                65: { desc: "Hujan Lebat", icon: 'rain-heavy' },
                66: { desc: "Hujan Beku Ringan", icon: 'rain-heavy' },
                67: { desc: "Hujan Beku Lebat", icon: 'rain-heavy' },
                71: { desc: "Salju Ringan", icon: 'cloud' }, // Placeholder icon
                73: { desc: "Salju Sedang", icon: 'cloud' }, // Placeholder icon
                75: { desc: "Salju Lebat", icon: 'cloud' }, // Placeholder icon
                77: { desc: "Butiran Salju", icon: 'cloud' }, // Placeholder icon
                80: { desc: "Hujan Lokal Ringan", icon: 'rain' },
                81: { desc: "Hujan Lokal Sedang", icon: 'rain' },
                82: { desc: "Hujan Lokal Lebat", icon: 'rain-heavy' },
                85: { desc: "Hujan Salju Ringan", icon: 'cloud' }, // Placeholder icon
                86: { desc: "Hujan Salju Lebat", icon: 'cloud' }, // Placeholder icon
                95: { desc: "Badai Petir", icon: 'thunderstorm' },
                96: { desc: "Badai Petir & Hujan Es Ringan", icon: 'thunderstorm' },
                99: { desc: "Badai Petir & Hujan Es Lebat", icon: 'thunderstorm' },
            };
            const info = descriptions[code] || { desc: "Tidak Diketahui", icon: 'sun' };
            const icons = {
                'sun': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#facc15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
                'moon': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
                'cloud': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#d1d5db" stroke="#d1d5db" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>`,
                'sun-cloud': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="#d1d5db" stroke="#d1d5db"></path><circle cx="12" cy="12" r="5" fill="#facc15" stroke="#facc15"></circle></svg>`,
                'moon-cloud': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="#9ca3af" stroke="#9ca3af"></path><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#d1d5db" stroke="#d1d5db"></path></svg>`,
                'rain': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="#9ca3af" stroke="#9ca3af"></path><path d="M10 16l-2 4m6-4l-2 4" stroke="#60a5fa"></path></svg>`,
                'rain-heavy': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="#6b7280" stroke="#6b7280"></path><path d="M10 16l-2 4m6-4l-2 4m-4-4l-2 4" stroke="#3b82f6"></path></svg>`,
                'thunderstorm': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" fill="#6b7280" stroke="#6b7280"></path><path d="m11 15-2 5h6l-2-5" stroke="#facc15" fill="#facc15"></path></svg>`,
                'fog': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M2 12h20"/><path d="M5 16h14"/><path d="M5 8h14"/></svg>`,
            };
            return { description: info.desc, icon: icons[info.icon] };
        }
        
        function getWindDirection(degrees) {
            const directions = ['Utara', 'Timur Laut', 'Timur', 'Tenggara', 'Selatan', 'Barat Daya', 'Barat', 'Barat Laut'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }

        // --- UI Update Functions ---
        function updateUI() {
            const { daily, current } = weatherData;
            const dayData = daily;
            
            const maxTemp = Math.round(dayData.temperature_2m_max[selectedDayIndex]);
            const minTemp = Math.round(dayData.temperature_2m_min[selectedDayIndex]);
            
            mainMaxTempEl.textContent = `${maxTemp}¬∞`;
            mainMinTempEl.textContent = `/${minTemp}¬∞`;

            let code, isDay, dayTime, desc;
            
            if (selectedDayIndex === 0) {
                code = current.weather_code;
                isDay = current.is_day;
                const windDirectionText = getWindDirection(current.wind_direction_10m);
                currentTempNowEl.textContent = `${Math.round(current.temperature_2m)}¬∞`;
                currentPrecipEl.textContent = `${current.precipitation} mm`;
                currentHumidityEl.textContent = `${current.relative_humidity_2m}%`;
                currentWindEl.textContent = `${Math.round(current.wind_speed_10m)} km/j dari ${windDirectionText}`;
                const now = new Date(current.time);
                dayTime = now.toLocaleDateString('id-ID', { weekday: 'long', hour: '2-digit', minute: '2-digit' }).replace(/\./g,':');
                desc = getWeatherInfo(code, isDay).description;
                otherDetailsEl.style.display = 'block';
            } else {
                code = dayData.weather_code[selectedDayIndex];
                isDay = 1; 
                const date = new Date(dayData.time[selectedDayIndex]);
                dayTime = date.toLocaleDateString('id-ID', { weekday: 'long' });
                desc = getWeatherInfo(code, isDay).description;
                otherDetailsEl.style.display = 'none';
            }

            const { icon } = getWeatherInfo(code, isDay);
            currentIconEl.innerHTML = icon;
            currentDayTimeEl.textContent = dayTime;
            currentDescriptionEl.textContent = desc;
            
            updateScenery(code, isDay);
            renderDailyForecast();
            updateChart();
        }

        function renderDailyForecast() {
            dailyContainer.innerHTML = '';
            weatherData.daily.time.forEach((day, index) => {
                const date = new Date(day);
                const dayAbbr = date.toLocaleDateString('id-ID', { weekday: 'short' });
                const dayOfMonth = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const formattedDate = `${dayOfMonth}/${month}`;
                
                const { icon } = getWeatherInfo(weatherData.daily.weather_code[index], 1);
                const maxTemp = Math.round(weatherData.daily.temperature_2m_max[index]);
                const minTemp = Math.round(weatherData.daily.temperature_2m_min[index]);

                const dayEl = document.createElement('button');
                dayEl.className = `p-2 text-center space-y-1 flex flex-col items-center justify-center focus:outline-none transition-colors ${index === selectedDayIndex ? 'active-day' : ''}`;
                dayEl.onclick = () => { selectedDayIndex = index; updateUI(); };
                dayEl.innerHTML = `
                    <p class="text-xs sm:text-sm font-medium">${dayAbbr}</p>
                    <p class="text-xs" style="color: var(--text-secondary);">${formattedDate}</p>
                    <div class="w-8 h-8 sm:w-10 sm:h-10 mx-auto my-1">${icon}</div>
                    <p class="text-xs sm:text-sm">
                        <span class="font-medium">${maxTemp}¬∞</span>
                        <span style="color: var(--text-secondary);">${minTemp}¬∞</span>
                    </p>`;
                dailyContainer.appendChild(dayEl);
            });
        }

        function updateChart() {
            if (!weatherData) return;
            const { hourly } = weatherData;
            const startIndex = selectedDayIndex * 24;
            const endIndex = startIndex + 24;

            const labels = hourly.time.slice(startIndex, endIndex).map(t => new Date(t).getHours() + ':00');
            let chartData, yLabel, color, type, fill, pointStyle = false, tooltipCallbacks = {}, showLine = true;

            switch(activeTab) {
                case 'precipitation':
                    chartData = hourly.precipitation_probability.slice(startIndex, endIndex);
                    yLabel = 'Curah Hujan (%)'; color = '#60a5fa'; type = 'bar'; fill = false;
                    break;
                case 'wind':
                    chartData = hourly.wind_speed_10m.slice(startIndex, endIndex);
                    const windDirections = hourly.wind_direction_10m.slice(startIndex, endIndex);
                    pointStyle = windDirections.map(deg => {
                        const arrow = document.createElement('canvas');
                        arrow.width = 24; arrow.height = 24;
                        const aCtx = arrow.getContext('2d');
                        aCtx.translate(12, 12); aCtx.rotate(deg * Math.PI / 180); aCtx.translate(-12, -12);
                        aCtx.beginPath(); aCtx.moveTo(12, 2); aCtx.lineTo(18, 18); aCtx.lineTo(12, 14); aCtx.lineTo(6, 18); aCtx.closePath();
                        aCtx.fillStyle = 'rgba(135, 206, 250, 0.7)'; aCtx.fill();
                        return arrow;
                    });
                    yLabel = 'Angin (km/j)'; color = 'rgba(135, 206, 250, 0.7)'; type = 'line'; fill = false; showLine = false;
                    tooltipCallbacks = {
                        label: function(context) {
                            const speed = context.parsed.y;
                            const degree = windDirections[context.dataIndex];
                            const directionText = getWindDirection(degree);
                            return `Angin: ${speed} km/j (${directionText} ${degree}¬∞)`;
                        }
                    };
                    break;
                default:
                    chartData = hourly.temperature_2m.slice(startIndex, endIndex);
                    yLabel = 'Suhu (¬∞C)'; color = '#facc15'; type = 'line'; fill = true;
            }

            if (hourlyChart) hourlyChart.destroy();
            
            hourlyChart = new Chart(hourlyChartCanvas, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: yLabel, data: chartData, borderColor: color, 
                        backgroundColor: fill ? 'rgba(250, 204, 21, 0.2)' : color, 
                        borderWidth: 2, tension: 0.4, pointRadius: activeTab === 'wind' ? 15 : 0, pointStyle: pointStyle, fill: fill,
                        showLine: showLine
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: tooltipCallbacks
                        } 
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color') } },
                        y: { grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color') }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color') }, beginAtZero: activeTab === 'precipitation' }
                    }
                }
            });
        }

        function updateThemeElements() {
            const isLight = document.documentElement.classList.contains('light');
            themeText.textContent = isLight ? 'Mode Terang' : 'Mode Gelap';
            const favicon = document.getElementById('favicon');
            favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${isLight ? '‚òÄÔ∏è' : 'üåô'}</text></svg>`;
            updateChart();
        }

        // --- Alert and Modal Logic ---
        function processAlerts() {
            const { hourly } = weatherData;
            let firstAlertTime = null;
            let alertsForModal = [];
            let allStaticAlerts = { rain: null, wind: null, temp: null };

            const now = new Date();
            const nowAtHourStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
            const startIndex = hourly.time.findIndex(t => new Date(t) > nowAtHourStart);

            if (startIndex === -1) return { allAlertsForStatic: [], alertsForModal: [] };

            const endIndex = startIndex + 24;

            for (let i = startIndex; i < endIndex && i < hourly.time.length; i++) {
                const isRain = hourly.precipitation_probability[i] >= ALERT_THRESHOLDS.RAIN_PROBABILITY;
                const isWindy = hourly.wind_speed_10m[i] >= ALERT_THRESHOLDS.WIND_SPEED;
                const isHot = hourly.temperature_2m[i] >= ALERT_THRESHOLDS.HIGH_TEMP;

                // For static alert (first occurrence of each type)
                if (isRain && !allStaticAlerts.rain) {
                    allStaticAlerts.rain = { text: `Hujan (${Math.round(hourly.precipitation_probability[i])}%) pkl ${new Date(hourly.time[i]).getHours()}:00` };
                }
                if (isWindy && !allStaticAlerts.wind) {
                    allStaticAlerts.wind = { text: `Angin kencang (${Math.round(hourly.wind_speed_10m[i])} km/j) pkl ${new Date(hourly.time[i]).getHours()}:00` };
                }
                if (isHot && !allStaticAlerts.temp) {
                    allStaticAlerts.temp = { text: `Suhu panas (${Math.round(hourly.temperature_2m[i])}¬∞C) pkl ${new Date(hourly.time[i]).getHours()}:00` };
                }

                // For modal alert (all alerts at the very first alert time)
                if ((isRain || isWindy || isHot) && firstAlertTime === null) {
                    firstAlertTime = new Date(hourly.time[i]);
                    if (isRain) alertsForModal.push({ type: 'rain', value: hourly.precipitation_probability[i] });
                    if (isWindy) alertsForModal.push({ type: 'wind', value: hourly.wind_speed_10m[i] });
                    if (isHot) alertsForModal.push({ type: 'temp', value: hourly.temperature_2m[i] });
                }
            }
            
            const staticAlertsArray = Object.values(allStaticAlerts).filter(alert => alert !== null);
            if (alertsForModal.length > 0) {
                 alertsForModal.forEach(alert => {
                    alert.time = firstAlertTime;
                    alert.location = LOCATIONS[locationSelect.value].name;
                });
            }

            return { allAlertsForStatic: staticAlertsArray, alertsForModal: alertsForModal };
        }
        
        function processNiceWeatherAlert() {
            const { hourly } = weatherData;
            const now = new Date();
            const nowAtHourStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
            const startIndex = hourly.time.findIndex(t => new Date(t) > nowAtHourStart);

            if (startIndex === -1) return null;

            const endIndex = startIndex + 24;
            for (let i = startIndex; i < endIndex && i < hourly.time.length; i++) {
                if (
                    hourly.weather_code[i] === NICE_WEATHER_THRESHOLDS.WEATHER_CODE &&
                    hourly.precipitation_probability[i] <= NICE_WEATHER_THRESHOLDS.RAIN_PROBABILITY &&
                    hourly.wind_speed_10m[i] <= NICE_WEATHER_THRESHOLDS.WIND_SPEED
                ) {
                    return { time: new Date(hourly.time[i]), location: LOCATIONS[locationSelect.value].name };
                }
            }
            return null;
        }

        function showStaticAlert(alerts) {
            staticAlertContainer.innerHTML = '';
            if (alerts && alerts.length > 0) {
                const alertMessage = "Peringatan: " + alerts.map(alert => alert.text).join(', ');
                staticAlertContainer.innerHTML = `
                    <div class="alert-box p-3 rounded-lg flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                        <p class="text-sm">${alertMessage}</p>
                    </div>`;
            }
        }

        function showAlertModal(alertInfos) {
            if (!alertInfos || alertInfos.length === 0) return;

            const titleEl = document.getElementById('alert-modal-title');
            const messageEl = document.getElementById('alert-modal-message');
            const tipEl = document.getElementById('alert-modal-tip');
            const iconContainerEl = document.getElementById('alert-modal-icon-container');
            const iconEl = document.getElementById('alert-modal-icon');
            
            const timeOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
            const formattedTime = alertInfos[0].time.toLocaleDateString('id-ID', timeOptions).replace(/\./g, ':').replace('pukul', 'sekitar pukul');
            
            titleEl.textContent = 'Peringatan Cuaca';
            
            let messagesHTML = `<p class="mb-2">Diperkirakan terjadi beberapa kondisi cuaca di <strong>${alertInfos[0].location}</strong> pada <strong>${formattedTime}</strong>:</p><ul class="list-disc pl-5 space-y-1">`;
            let tipsHTML = '<strong>Tips:</strong><ul class="list-disc pl-5 space-y-1 mt-1">';
            
            const severityOrder = ['rain', 'wind', 'temp'];
            alertInfos.sort((a, b) => severityOrder.indexOf(a.type) - severityOrder.indexOf(b.type));

            alertInfos.forEach(alertInfo => {
                let message, tip;
                switch (alertInfo.type) {
                    case 'rain':
                        message = `Potensi hujan (${Math.round(alertInfo.value)}%)`;
                        tip = 'Sedia payung/jas hujan & waspada jalanan licin.';
                        break;
                    case 'wind':
                        message = `Potensi angin kencang (${Math.round(alertInfo.value)} km/j)`;
                        tip = 'Amankan barang di luar & hindari pohon besar.';
                        break;
                    case 'temp':
                        message = `Potensi suhu panas (${Math.round(alertInfo.value)}¬∞C)`;
                        tip = 'Minum air cukup & hindari paparan matahari.';
                        break;
                }
                messagesHTML += `<li>${message}</li>`;
                tipsHTML += `<li>${tip}</li>`;
            });
            
            messagesHTML += '</ul>';
            tipsHTML += '</ul>';
            messageEl.innerHTML = messagesHTML;
            tipEl.innerHTML = tipsHTML;

            const primaryAlert = alertInfos[0];
            let iconContainerClass, iconClass, iconPath;
             switch (primaryAlert.type) {
                case 'rain':
                    iconContainerClass = 'bg-blue-100'; iconClass = 'text-blue-600';
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l-2 3m4-3l-2 3" />';
                    break;
                case 'wind':
                    iconContainerClass = 'bg-gray-200'; iconClass = 'text-gray-600';
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />';
                    break;
                case 'temp':
                    iconContainerClass = 'bg-orange-100'; iconClass = 'text-orange-600';
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />';
                    break;
            }
            iconContainerEl.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${iconContainerClass} mb-4`;
            iconEl.className = `h-6 w-6 ${iconClass}`;
            iconEl.innerHTML = iconPath;

            alertModal.classList.remove('hidden');
        }
        
        function showNiceWeatherModal(niceWeatherInfo) {
            const messageEl = document.getElementById('nice-modal-message');
            const tipEl = document.getElementById('nice-modal-tip');
            const timeOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
            const formattedTime = niceWeatherInfo.time.toLocaleDateString('id-ID', timeOptions).replace(/\./g, ':').replace('pukul', 'sekitar pukul');

            messageEl.innerHTML = `Cuaca cerah diperkirakan di <strong>${niceWeatherInfo.location}</strong> pada <strong>${formattedTime}</strong>.`;
            tipEl.innerHTML = '<strong>Tips:</strong> Waktu yang tepat untuk beraktivitas di luar ruangan. Jangan lupa gunakan tabir surya!';
            niceWeatherModal.classList.remove('hidden');
        }
        
        // --- Share Function (Download Image) ---
        async function downloadWeatherImage() {
            try {
                // Temporarily hide modals to capture a clean screenshot
                alertModal.classList.add('hidden');
                firstVisitModal.classList.add('hidden');
                niceWeatherModal.classList.add('hidden');

                const canvas = await html2canvas(document.getElementById('weather-content'), {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg-color')
                });
                const dataUrl = canvas.toDataURL('image/png');

                const link = document.createElement('a');
                link.download = `cuaca-${LOCATIONS[locationSelect.value].name.toLowerCase()}-${new Date().toISOString().split('T')[0]}.png`;
                link.href = dataUrl;
                link.click();
            } catch (err) {
                console.error("Gagal membagikan gambar:", err);
                alert('Gagal membagikan gambar cuaca.');
            }
        }
        
        function getScenery(weatherCode, isDay) {
            const sceneries = {
                clearDay: `<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice" style="width: 100%; height: 100%;"><defs><radialGradient id="grad1" cx="50%" cy="100%" r="100%"><stop offset="0%" style="stop-color:rgb(135,206,235);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(0,191,255);stop-opacity:1" /></radialGradient></defs><rect width="100" height="100" fill="url(#grad1)" /><circle cx="25" cy="25" r="10" fill="yellow" /></svg>`,
                clearNight: `<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice" style="width: 100%; height: 100%;"><defs><radialGradient id="grad2" cx="50%" cy="0%" r="100%"><stop offset="0%" style="stop-color:rgb(25,25,112);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(0,0,0);stop-opacity:1" /></radialGradient></defs><rect width="100" height="100" fill="url(#grad2)" /><path d="M 75 20 A 20 20, 0, 1, 0, 70 45 A 15 15, 0, 1, 1, 75 20" fill="white"/><circle cx="20" cy="30" r="1" fill="white"/><circle cx="40" cy="15" r="0.5" fill="white"/><circle cx="60" cy="50" r="1" fill="white"/><circle cx="85" cy="60" r="0.7" fill="white"/></svg>`,
                cloudy: `<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice" style="width: 100%; height: 100%;"><rect width="100" height="100" fill="#d3d3d3" /><path d="M -10 80 Q 20 60, 50 80 T 110 80" stroke="none" fill="rgba(255,255,255,0.5)" /><path d="M -10 70 Q 30 50, 60 70 T 120 70" stroke="none" fill="rgba(255,255,255,0.6)" /></svg>`,
                rain: `<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice" style="width: 100%; height: 100%;"><rect width="100" height="100" fill="#808080" /><path d="M -10 80 Q 20 60, 50 80 T 110 80" stroke="none" fill="rgba(169,169,169,0.8)" /><path d="M -10 70 Q 30 50, 60 70 T 120 70" stroke="none" fill="rgba(169,169,169,0.9)" /><line x1="10" y1="80" x2="20" y2="100" stroke="#add8e6" stroke-width="0.5"/><line x1="30" y1="80" x2="40" y2="100" stroke="#add8e6" stroke-width="0.5"/><line x1="50" y1="80" x2="60" y2="100" stroke="#add8e6" stroke-width="0.5"/><line x1="70" y1="80" x2="80" y2="100" stroke="#add8e6" stroke-width="0.5"/><line x1="90" y1="80" x2="100" y2="100" stroke="#add8e6" stroke-width="0.5"/></svg>`,
                fog: `<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice" style="width: 100%; height: 100%;"><defs><linearGradient id="grad3" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:rgb(192,192,192);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(211,211,211);stop-opacity:1" /></linearGradient></defs><rect width="100" height="100" fill="url(#grad3)" /></svg>`
            };
            
            if (weatherCode <= 1) return isDay ? sceneries.clearDay : sceneries.clearNight;
            if (weatherCode <= 3) return sceneries.cloudy;
            if ((weatherCode >= 61 && weatherCode <= 82) || weatherCode >= 95) return sceneries.rain;
            if (weatherCode >= 45 && weatherCode <= 48) return sceneries.fog;
            return isDay ? sceneries.clearDay : sceneries.clearNight; // Default
        }

        function updateScenery(weatherCode, isDay) {
            sceneryContainer.innerHTML = getScenery(weatherCode, isDay);
        }

        // --- Live Clock ---
        function startLiveClock() {
            setInterval(() => {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                liveDateTimeEl.textContent = now.toLocaleDateString('id-ID', options).replace(/\./g, ':');
            }, 1000);
        }

        // --- Event Listeners ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                activeTab = button.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                button.classList.add('active-tab');
                updateChart();
            });
        });
        
        locationSelect.addEventListener('change', (e) => fetchAndRenderWeather(e.target.value));

        themeToggle.addEventListener('change', () => {
            document.documentElement.classList.toggle('light');
            localStorage.setItem('theme', document.documentElement.classList.contains('light') ? 'light' : 'dark');
            updateThemeElements();
        });

        shareBtn.addEventListener('click', downloadWeatherImage);
        shareAlertBtn.addEventListener('click', downloadWeatherImage);
        shareNiceBtn.addEventListener('click', downloadWeatherImage);
        
        // Modal Closing Logic
        closeVisitModalBtn.addEventListener('click', () => {
            firstVisitModal.classList.add('hidden');
            localStorage.setItem('hasSeenThemeModal', 'true');
        });
        firstVisitModal.addEventListener('click', (e) => {
            if (e.target === firstVisitModal) {
                 firstVisitModal.classList.add('hidden');
                 localStorage.setItem('hasSeenThemeModal', 'true');
            }
        });
        closeAlertModalBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
        alertModal.addEventListener('click', (e) => {
            if (e.target === alertModal) alertModal.classList.add('hidden');
        });
        closeNiceModalBtn.addEventListener('click', () => niceWeatherModal.classList.add('hidden'));
        niceWeatherModal.addEventListener('click', (e) => {
            if (e.target === niceWeatherModal) niceWeatherModal.classList.add('hidden');
        });

        // --- Initial Fetch ---
        async function fetchAndRenderWeather(locationKey = 'rumah') {
            loader.style.display = 'block';
            weatherContent.classList.add('hidden');
            selectedDayIndex = 0;

            try {
                const response = await fetch(LOCATIONS[locationKey].url);
                if (!response.ok) throw new Error('Gagal mengambil data cuaca');
                weatherData = await response.json();
                loader.style.display = 'none';
                weatherContent.classList.remove('hidden');
                updateUI();
                
                const { allAlertsForStatic, alertsForModal } = processAlerts();
                showStaticAlert(allAlertsForStatic);
                const niceWeatherInfo = processNiceWeatherAlert();
                
                if (alertsForModal.length > 0) {
                    setTimeout(() => showAlertModal(alertsForModal), 1000);
                } else if (niceWeatherInfo) {
                    setTimeout(() => showNiceWeatherModal(niceWeatherInfo), 1000);
                } else if (!localStorage.getItem('hasSeenThemeModal')) {
                    firstVisitModal.classList.remove('hidden');
                }

            } catch (error) {
                console.error(error);
                loader.style.display = 'none';
                weatherContent.innerHTML = `<p class="text-center">Tidak dapat memuat data cuaca.</p>`;
                weatherContent.classList.remove('hidden');
            }
        }
        
        // --- Initial Load ---
        function init() {
            // Set theme based on saved preference. Default to light.
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.remove('light');
                themeToggle.checked = false;
            } else {
                document.documentElement.classList.add('light');
                themeToggle.checked = true;
            }
            updateThemeElements();
            startLiveClock();
            
            fetchAndRenderWeather(locationSelect.value);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
